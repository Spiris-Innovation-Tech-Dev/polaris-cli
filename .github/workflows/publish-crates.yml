name: Publish crates

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/publish-crates.yml"
      - "Cargo.toml"
      - "Cargo.lock"
      - "polaris-api/**"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: crates-publish
  cancel-in-progress: false

jobs:
  verify:
    name: Verify workspace
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Run Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Run tests
        run: cargo test --workspace

  publish-polaris-api:
    name: Publish polaris-api
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Check polaris-api version on crates.io
        id: check_version
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(sed -n 's/^version = "\(.*\)"/\1/p' polaris-api/Cargo.toml | head -1)"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

          STATUS="$(curl -sS -o /dev/null -w "%{http_code}" -H "User-Agent: polaris-cli-ci/1.0" "https://crates.io/api/v1/crates/polaris-api/${VERSION}")"
          if [[ "${STATUS}" == "200" ]]; then
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            echo "polaris-api ${VERSION} already exists on crates.io"
          else
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
            echo "polaris-api ${VERSION} does not exist on crates.io"
          fi

      - name: Publish polaris-api
        if: steps.check_version.outputs.should_publish == 'true'
        run: cargo publish -p polaris-api
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

